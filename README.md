# forge

Tools for distributing ssl certificates

A Linux port of the [anvil](https://github.com/dlangille/anvil) package written by [@dlangille](https://github.com/dlangille)

Ported to CentOS-7, it uses curl by default, but can also use wget.
Set FETCH_TOOL in the configuration file to use wget. Any other value
will invoke curl.

It also uses sudo, with the goal of this running as non-root and only allowing the cp & mv via sudo.

These tools were designed with acme.sh & Let's Encrypt in mind, but they
should with with any certificates generated by any means.

Relevant background:

* The certificates are being generated via acme.sh in a centralized location.
* certs are not generated where they are used.
* Distribution of private keys is outside scope.
* New certs are pulled by the servers/VMs/jails/etc which need them.

The steps to use this stuff:

* create certs in /var/db/acme
* run cert-shifter (see https://github.com/dlangille/anvil-certs/blob/master/collect-certs)
* rsync from /var/db/certs-for-rsync to https://example.org/certs
* run cert-puller to download and install new certs

The distribution of private keys is outside scope.

<p align="center">Overview of anvil use</p>
<img src ="https://github.com/dlangille/anvil/blob/master/images/anvil-overiew.png?raw=true" title="Overview of anvil use" alt="Overview of anvil use"/>


Before using:

```
# create system user without shell
useradd -r -U -d /opt/work/forge/var -c "forge certificate handler" -s /sbin/nologin USER
```
Where USER is the user which will be invoking this script. We
suggest forge

```
# create forge home directory and apply permissions
mkdir -p /opt/work/forge/var && chown USER:GROUP /opt/work/forge/var
```
Where USER & GROUP is the user which will be invoking this script. We
suggest forge:forge

Said user will also need sudo rights to cp and mv within CERT_DST.

Default configuration files are in /opt/work/forge/etc/


## [NOTE] cert-shifter has not yet been ported to Linux
Variables which can be set in cert-shifter.conf:

```
CERT_SRC="/var/db/acme/certs"
CERT_DST_ROOT="/var/db/certs-for-rsync"
CERT_DST_CERTS="${CERT_DST_ROOT}/certs"
TMP="${CERT_DST_ROOT}/tmp"
```

## [NOTE] cert-puller has been ported to linux
Variables which can be set in cert-puller.conf:

```
CERT_DST="/opt/work/ssl"
CERT_SERVER="https://certs.example.org/certs"
MYCERTS="example.com"
SERVICES="httpd"
DOWNLOAD_DIR="/opt/work/forge/var"
USER_AGENT="--user-agent='forge-cert-puller'"
CURL="/usr/local/bin/curl --silent --user-agent '${USER_AGENT}' --remote-time"
WGET="/usr/local/bin/wget --quiet --user-agent='${USER_AGENT}'"

```

Services which can be restarted by this code: httpd, dovecot, postfix.

To use wget, set FETCH_TOOL="wget" in cert-puller.conf

To use curl, set FETCH_TOOL="curl" in cert-puller.conf
